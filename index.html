<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Auditor√≠a - Guatemala</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: #000; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); }

        .status-box {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .status-box h3 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success { background: rgba(40,167,69,0.1); border-color: #28a745; color: #155724; }
        .alert-error { background: rgba(220,53,69,0.1); border-color: #dc3545; color: #721c24; }
        .alert-info { background: rgba(23,162,184,0.1); border-color: #17a2b8; color: #0c5460; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .container { padding: 20px; margin: 10px; }
        }

        .hidden { display: none; }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üá¨üáπ Sistema de Auditor√≠a</h1>
        <p class="subtitle">Guatemala - Correos con EmailJS</p>

        <!-- Estado de EmailJS -->
        <div class="status-box" id="statusBox">
            <h3 id="statusTitle">üîÑ Verificando EmailJS...</h3>
            <p id="statusMessage">Iniciando sistema...</p>
            <div id="statusButtons" class="hidden">
                <button class="btn btn-success" onclick="testEmail()">üß™ Enviar Prueba</button>
                <button class="btn btn-warning" onclick="retryEmailJS()">üîÑ Reintentar</button>
                <button class="btn" onclick="diagnoseEmailJS()" style="background: #17a2b8;">üîç Diagn√≥stico</button>
                <button class="btn btn-danger" onclick="forceTestEmail()">‚ö° Prueba Forzada</button>
            </div>
        </div>

        <!-- Formulario de correos -->
        <div id="emailForm" class="hidden">
            <h3>üìß Enviar Correo</h3>
            <form onsubmit="sendEmail(event)">
                <div class="grid">
                    <div class="form-group">
                        <label>Para:</label>
                        <input type="email" id="emailTo" required>
                    </div>
                    <div class="form-group">
                        <label>Asunto:</label>
                        <input type="text" id="emailSubject" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Mensaje:</label>
                    <textarea id="emailMessage" rows="6" required></textarea>
                </div>
                <button type="submit" class="btn">üìß Enviar Correo</button>
            </form>

            <!-- Plantillas -->
            <div style="margin-top: 30px;">
                <h4>üìã Plantillas R√°pidas:</h4>
                <button class="btn btn-warning" onclick="loadTemplate('audit')">Solicitud Auditor√≠a</button>
                <button class="btn btn-warning" onclick="loadTemplate('report')">Reporte</button>
                <button class="btn btn-warning" onclick="loadTemplate('reminder')">Recordatorio</button>
            </div>
        </div>

        <!-- Historial -->
        <div id="historySection" class="hidden">
            <h3>üì¨ Historial de Correos</h3>
            <div id="emailHistory">
                <p>No hay correos enviados</p>
            </div>
        </div>
    </div>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script>
        // Estado global simple
        let emailHistory = [];
        let emailjsReady = false;

        // Configuraci√≥n EmailJS
        const CONFIG = {
            publicKey: 'oRv0UzebO2bmLUcBi',
            serviceId: 'service_b3bbf3j',
            templateId: 'template_48fcljb'
        };

        // Verificar si EmailJS est√° disponible
        function checkEmailJSAvailability() {
            try {
                // Verificar m√∫ltiples formas
                const emailjsObj = window.emailjs || window.EmailJS || emailjs;
                
                if (emailjsObj && typeof emailjsObj.send === 'function') {
                    console.log('‚úÖ EmailJS encontrado!');
                    
                    // Intentar inicializar
                    emailjsObj.init(CONFIG.publicKey);
                    emailjsReady = true;
                    
                    updateStatus('success', 'üéâ EmailJS Configurado y Listo', 
                        '‚úÖ Public Key: ' + CONFIG.publicKey + '\n‚úÖ Listo para enviar correos directamente');
                    
                    document.getElementById('emailForm').classList.remove('hidden');
                    document.getElementById('historySection').classList.remove('hidden');
                    
                    // Asignar objeto global para usar en las funciones de env√≠o
                    window.emailjsInstance = emailjsObj;
                    
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Error inicializando EmailJS:', error);
            }
            
            return false;
        }

        // Inicializar EmailJS con m√∫ltiples intentos
        function initEmailJS() {
            console.log('üîÑ Inicializando EmailJS...');
            
            // Intento 1: Verificar disponibilidad inmediata
            if (checkEmailJSAvailability()) {
                return;
            }
            
            // Intento 2: Esperar 2 segundos
            setTimeout(() => {
                console.log('üîÑ Segundo intento...');
                if (checkEmailJSAvailability()) {
                    return;
                }
                
                // Intento 3: Esperar 5 segundos m√°s
                setTimeout(() => {
                    console.log('üîÑ Tercer intento...');
                    if (checkEmailJSAvailability()) {
                        return;
                    }
                    
                    // Si nada funciona, usar respaldo
                    console.log('‚ö†Ô∏è EmailJS no disponible, activando respaldo');
                    activateBackupMode();
                    
                }, 3000);
            }, 2000);
        }

        // Activar modo respaldo
        function activateBackupMode() {
            emailjsReady = false;
            updateStatus('error', '‚ö†Ô∏è EmailJS No Disponible', 
                'Usando cliente local como respaldo (Gmail, Outlook, etc.)\n\nPuedes enviar correos pero se abrir√° tu cliente de correo.');
            
            document.getElementById('emailForm').classList.remove('hidden');
            document.getElementById('historySection').classList.remove('hidden');
        }

        // Funci√≥n auxiliar para mostrar estado de carga
        function updateStatus(type, title, message) {
            const statusBox = document.getElementById('statusBox');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const statusButtons = document.getElementById('statusButtons');

            statusTitle.textContent = title;
            statusMessage.textContent = message;

            if (type === 'success') {
                statusBox.style.background = 'rgba(40, 167, 69, 0.1)';
                statusBox.style.borderColor = '#28a745';
                statusButtons.classList.remove('hidden');
            } else if (type === 'error') {
                statusBox.style.background = 'rgba(255, 193, 7, 0.1)';
                statusBox.style.borderColor = '#ffc107';
                statusButtons.classList.remove('hidden');
            } else if (type === 'loading') {
                statusBox.style.background = 'rgba(23, 162, 184, 0.1)';
                statusBox.style.borderColor = '#17a2b8';
                statusButtons.classList.add('hidden');
            }
        }

        // Enviar email de prueba
        async function testEmail() {
            const testEmail = prompt('üìß ¬øA qu√© email enviar la prueba?', 'tu-email@gmail.com');
            if (!testEmail) return;

            showAlert('info', 'üîÑ Enviando correo de prueba...');

            if (emailjsReady && window.emailjsInstance) {
                try {
                    // Usar la instancia verificada de EmailJS
                    const emailjsObj = window.emailjsInstance;
                    
                    // Par√°metros b√°sicos que funcionan con cualquier plantilla
                    const templateParams = {
                        to_name: testEmail.split('@')[0],
                        from_name: 'Sistema Auditor√≠a Guatemala',
                        to_email: testEmail,
                        from_email: 'sistema@auditoria.gt',
                        subject: 'üß™ Prueba EmailJS - ¬°FUNCIONA!',
                        message: `¬°Felicidades! 

Tu configuraci√≥n de EmailJS est√° funcionando correctamente.

‚úÖ Credenciales v√°lidas
‚úÖ Servicio conectado
‚úÖ Plantilla operativa
‚úÖ Sistema listo

Ya puedes enviar correos directamente desde la aplicaci√≥n.

Saludos,
Sistema de Auditor√≠a Guatemala üá¨üáπ`,
                        reply_to: 'sistema@auditoria.gt'
                    };

                    console.log('üì§ Enviando con par√°metros:', templateParams);
                    console.log('üîß Config:', CONFIG);

                    // Enviar usando la instancia verificada
                    const result = await emailjsObj.send(CONFIG.serviceId, CONFIG.templateId, templateParams);

                    console.log('üìß Resultado:', result);

                    if (result.status === 200) {
                        addToHistory(testEmail, 'üß™ Prueba EmailJS', 'EmailJS');
                        showAlert('success', `üéâ ¬°CORREO ENVIADO EXITOSAMENTE!

‚úÖ Destinatario: ${testEmail}
‚úÖ M√©todo: EmailJS directo
‚úÖ Estado: Enviado

Revisa tu bandeja de entrada en 1-2 minutos.`);
                    } else {
                        throw new Error(`Status: ${result.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error EmailJS:', error);
                    
                    // Mostrar error espec√≠fico y usar respaldo
                    let errorMsg = 'Error con EmailJS: ';
                    if (error.text) {
                        errorMsg += error.text;
                    } else {
                        errorMsg += error.message || 'Error desconocido';
                    }
                    
                    showAlert('error', '‚ùå ' + errorMsg + ' - Usando cliente local como respaldo...');
                    
                    // Respaldo con cliente local
                    sendLocalEmail(testEmail, 'üß™ Prueba Sistema (Respaldo)', 
                        'Prueba del sistema usando cliente local como respaldo.\n\nEmailJS present√≥ problemas, pero el sistema funciona correctamente con tu cliente de correo.');
                }
            } else {
                console.log('üîÑ EmailJS no disponible, usando cliente local...');
                sendLocalEmail(testEmail, 'üß™ Prueba Sistema', 
                    'EmailJS no est√° disponible, pero el sistema funciona correctamente usando tu cliente de correo local.');
            }
        }

        // Enviar correo normal
        async function sendEmail(event) {
            event.preventDefault();
            
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;

            showAlert('info', 'üì§ Enviando correo...');

            if (emailjsReady && window.emailjsInstance) {
                try {
                    const emailjsObj = window.emailjsInstance;
                    
                    const templateParams = {
                        to_name: to.split('@')[0],
                        from_name: 'Sistema Auditor√≠a Guatemala',
                        to_email: to,
                        from_email: 'sistema@auditoria.gt',
                        subject: subject,
                        message: message,
                        reply_to: 'sistema@auditoria.gt'
                    };

                    console.log('üì§ Enviando correo normal:', templateParams);

                    const result = await emailjsObj.send(CONFIG.serviceId, CONFIG.templateId, templateParams);

                    if (result.status === 200) {
                        addToHistory(to, subject, 'EmailJS');
                        showAlert('success', `‚úÖ Correo enviado exitosamente a ${to} via EmailJS`);
                        event.target.reset();
                    } else {
                        throw new Error(`Status: ${result.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    showAlert('error', '‚ùå Error con EmailJS, usando cliente local...');
                    sendLocalEmail(to, subject, message);
                    event.target.reset();
                }
            } else {
                sendLocalEmail(to, subject, message);
                event.target.reset();
            }
        }

        // Enviar con cliente local
        function sendLocalEmail(to, subject, body) {
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            addToHistory(to, subject, 'Cliente Local');
            showAlert('success', `üìß Cliente de correo abierto para ${to}`);
        }

        // Cargar plantillas
        function loadTemplate(type) {
            const templates = {
                audit: {
                    subject: 'Solicitud de Auditor√≠a - Guatemala 2025',
                    message: `Estimado/a,

Solicito cotizaci√≥n para auditor√≠a de inventarios.

DETALLES:
‚Ä¢ Empresa: [Nombre]
‚Ä¢ Ubicaci√≥n: Guatemala
‚Ä¢ Per√≠odo: 2025
‚Ä¢ Servicios: Auditor√≠a + VNR

Gracias por su atenci√≥n.

Saludos,
Sistema de Auditor√≠a Guatemala üá¨üáπ`
                },
                report: {
                    subject: 'Reporte de Inventario - ' + new Date().toLocaleDateString(),
                    message: `Estimado/a,

Adjunto reporte de inventario actualizado.

RESUMEN:
‚Ä¢ Fecha: ${new Date().toLocaleDateString()}
‚Ä¢ Total productos: [Cantidad]
‚Ä¢ Valor total: Q. [Monto]

Saludos,
Departamento de Auditor√≠a üá¨üáπ`
                },
                reminder: {
                    subject: 'Recordatorio - Auditor√≠a Programada',
                    message: `Estimado/a,

Recordatorio de auditor√≠a programada:

DETALLES:
‚Ä¢ Fecha: [Completar]
‚Ä¢ Hora: [Completar]
‚Ä¢ Lugar: [Completar]

Confirme su asistencia.

Saludos,
Sistema de Auditor√≠a Guatemala üá¨üáπ`
                }
            };

            const template = templates[type];
            document.getElementById('emailSubject').value = template.subject;
            document.getElementById('emailMessage').value = template.message;
            showAlert('info', `üìß Plantilla "${type}" cargada`);
        }

        // Diagn√≥stico completo paso a paso
        function diagnoseEmailJS() {
            console.log('üîç INICIANDO DIAGN√ìSTICO PASO A PASO...');
            
            let diagnosticSteps = [];
            
            // Paso 1: Verificar carga de EmailJS
            console.log('Paso 1: Verificando carga de EmailJS...');
            const step1 = typeof emailjs !== 'undefined';
            diagnosticSteps.push(`1. EmailJS global: ${step1 ? '‚úÖ Disponible' : '‚ùå No disponible'}`);
            
            // Paso 2: Verificar window.emailjs
            console.log('Paso 2: Verificando window.emailjs...');
            const step2 = typeof window.emailjs !== 'undefined';
            diagnosticSteps.push(`2. window.emailjs: ${step2 ? '‚úÖ Disponible' : '‚ùå No disponible'}`);
            
            // Paso 3: Verificar variable emailjsReady
            console.log('Paso 3: Verificando estado interno...');
            diagnosticSteps.push(`3. Sistema interno listo: ${emailjsReady ? '‚úÖ S√≠' : '‚ùå No'}`);
            
            // Paso 4: Verificar instancia guardada
            console.log('Paso 4: Verificando instancia guardada...');
            const step4 = !!window.emailjsInstance;
            diagnosticSteps.push(`4. Instancia guardada: ${step4 ? '‚úÖ S√≠' : '‚ùå No'}`);
            
            // Paso 5: Verificar configuraci√≥n
            console.log('Paso 5: Verificando configuraci√≥n...');
            diagnosticSteps.push(`5. Public Key: ${CONFIG.publicKey ? '‚úÖ Configurada' : '‚ùå Faltante'}`);
            diagnosticSteps.push(`6. Service ID: ${CONFIG.serviceId ? '‚úÖ Configurada' : '‚ùå Faltante'}`);
            diagnosticSteps.push(`7. Template ID: ${CONFIG.templateId ? '‚úÖ Configurada' : '‚ùå Faltante'}`);
            
            // Mostrar diagn√≥stico
            const diagText = `üîç DIAGN√ìSTICO DETALLADO

${diagnosticSteps.join('\n')}

üîß CREDENCIALES ACTUALES:
‚Ä¢ Public Key: ${CONFIG.publicKey}
‚Ä¢ Service ID: ${CONFIG.serviceId}  
‚Ä¢ Template ID: ${CONFIG.templateId}

üåê INFO T√âCNICA:
‚Ä¢ Navegador: ${navigator.userAgent.substring(0, 50)}...
‚Ä¢ Fecha/Hora: ${new Date().toLocaleString()}

üí° RECOMENDACI√ìN:
${(step1 || step2) && emailjsReady ? 
    '‚úÖ Todo parece estar bien. Intenta enviar correo de prueba.' : 
    '‚ùå Hay problemas. Intenta "Reintentar" o usa cliente local.'}`;

            alert(diagText);
            
            // Log detallado en consola
            console.log('=== DIAGN√ìSTICO COMPLETO ===');
            diagnosticSteps.forEach(step => console.log(step));
            console.log('emailjsReady:', emailjsReady);
            console.log('window.emailjsInstance:', window.emailjsInstance);
            console.log('typeof emailjs:', typeof emailjs);
            console.log('typeof window.emailjs:', typeof window.emailjs);
            console.log('CONFIG:', CONFIG);
            console.log('===============================');
            
            // Mostrar recomendaci√≥n
            if (!step1 && !step2) {
                showAlert('error', '‚ùå EmailJS no se carg√≥. Verifica tu conexi√≥n a internet.');
            } else if (!emailjsReady) {
                showAlert('error', '‚ùå EmailJS cargado pero no inicializado. Problema con inicializaci√≥n.');
            } else {
                showAlert('success', '‚úÖ Diagn√≥stico completado. Revisa los detalles en el popup.');
            }
        }

        // Funci√≥n de prueba forzada (para debug)
        async function forceTestEmail() {
            console.log('üß™ PRUEBA FORZADA DE EMAIL...');
            
            const testEmail = prompt('üìß Email para prueba FORZADA:', 'test@gmail.com');
            if (!testEmail) return;

            // Intentar todos los m√©todos posibles
            console.log('üîÑ Intentando m√©todo 1: emailjs global...');
            if (typeof emailjs !== 'undefined') {
                try {
                    const result = await emailjs.send(CONFIG.serviceId, CONFIG.templateId, {
                        to_email: testEmail,
                        subject: 'Prueba Forzada 1',
                        message: 'Prueba usando emailjs global'
                    });
                    console.log('‚úÖ M√©todo 1 exitoso:', result);
                    showAlert('success', '‚úÖ M√©todo 1 (emailjs global) funcion√≥!');
                    return;
                } catch (error) {
                    console.log('‚ùå M√©todo 1 fall√≥:', error);
                }
            }

            console.log('üîÑ Intentando m√©todo 2: window.emailjs...');
            if (typeof window.emailjs !== 'undefined') {
                try {
                    const result = await window.emailjs.send(CONFIG.serviceId, CONFIG.templateId, {
                        to_email: testEmail,
                        subject: 'Prueba Forzada 2',
                        message: 'Prueba usando window.emailjs'
                    });
                    console.log('‚úÖ M√©todo 2 exitoso:', result);
                    showAlert('success', '‚úÖ M√©todo 2 (window.emailjs) funcion√≥!');
                    return;
                } catch (error) {
                    console.log('‚ùå M√©todo 2 fall√≥:', error);
                }
            }

            console.log('üîÑ Intentando m√©todo 3: instancia guardada...');
            if (window.emailjsInstance) {
                try {
                    const result = await window.emailjsInstance.send(CONFIG.serviceId, CONFIG.templateId, {
                        to_email: testEmail,
                        subject: 'Prueba Forzada 3',
                        message: 'Prueba usando instancia guardada'
                    });
                    console.log('‚úÖ M√©todo 3 exitoso:', result);
                    showAlert('success', '‚úÖ M√©todo 3 (instancia guardada) funcion√≥!');
                    return;
                } catch (error) {
                    console.log('‚ùå M√©todo 3 fall√≥:', error);
                }
            }

            console.log('‚ùå Todos los m√©todos EmailJS fallaron, usando cliente local...');
            sendLocalEmail(testEmail, 'üß™ Prueba Forzada (Cliente Local)', 
                'Todos los m√©todos de EmailJS fallaron, usando cliente local como respaldo.');
        }

        // Agregar al historial
        function addToHistory(to, subject, method) {
            emailHistory.push({
                to: to,
                subject: subject,
                method: method,
                date: new Date().toLocaleString()
            });
            updateHistory();
        }

        // Actualizar historial
        function updateHistory() {
            const historyDiv = document.getElementById('emailHistory');
            let html = '';

            if (emailHistory.length === 0) {
                html = '<p>No hay correos enviados</p>';
            } else {
                emailHistory.forEach(email => {
                    html += `
                        <div class="history-item">
                            <strong>üìß ${email.subject}</strong><br>
                            <small>Para: ${email.to} ‚Ä¢ ${email.date} ‚Ä¢ ${email.method}</small>
                        </div>
                    `;
                });
            }
            
            historyDiv.innerHTML = html;
        }

        // Mostrar alerta
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Reintentar EmailJS
        function retryEmailJS() {
            showAlert('info', 'üîÑ Reintentando cargar EmailJS...');
            setTimeout(initEmailJS, 1000);
        }

        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', function() {
            console.log('üá¨üáπ Sistema iniciado');
            
            // Mostrar estado de carga inmediatamente
            updateStatus('loading', 'üîÑ Cargando EmailJS...', 'Verificando disponibilidad del servicio...');
            
            // Comenzar verificaci√≥n inmediatamente
            initEmailJS();
        });

        console.log('‚úÖ Sistema de Auditor√≠a Guatemala - Versi√≥n GitHub Pages');
    </script>
</body>
</html>
